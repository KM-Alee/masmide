name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.1.0)'
        required: true

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 (glibc)
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            arch: x86_64
            cross: false
          
          # Linux aarch64 (glibc)
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            arch: aarch64
            cross: true
          
          # Linux x86_64 (musl - static binary)
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            arch: x86_64-musl
            cross: true

    steps:
      - uses: actions/checkout@v4
      
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}
      
      - name: Install cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross
      
      - name: Build release binary
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi
      
      - name: Strip binary
        run: |
          if [ "${{ matrix.cross }}" = "true" ] && [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            # Cross-compiled aarch64 needs specific strip
            docker run --rm -v $PWD:/workspace ghcr.io/cross-rs/${{ matrix.target }}:main \
              aarch64-linux-gnu-strip /workspace/target/${{ matrix.target }}/release/masmide
          elif [ "${{ matrix.arch }}" = "x86_64-musl" ]; then
            # musl binary - strip with standard strip
            strip target/${{ matrix.target }}/release/masmide || true
          else
            strip target/${{ matrix.target }}/release/masmide
          fi
      
      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create tarball
        run: |
          VERSION=${{ steps.version.outputs.version }}
          ARCHIVE_NAME="masmide-${VERSION}-linux-${{ matrix.arch }}"
          
          mkdir -p "release/${ARCHIVE_NAME}"
          cp target/${{ matrix.target }}/release/masmide "release/${ARCHIVE_NAME}/"
          cp README.md LICENSE "release/${ARCHIVE_NAME}/"
          cp install.sh uninstall.sh "release/${ARCHIVE_NAME}/"
          
          # Copy Irvine library (excluding large Examples folder)
          mkdir -p "release/${ARCHIVE_NAME}/Irvine"
          cp Irvine/*.lib Irvine/*.Lib Irvine/*.obj Irvine/*.inc "release/${ARCHIVE_NAME}/Irvine/" 2>/dev/null || true
          
          # Copy templates
          cp -r templates "release/${ARCHIVE_NAME}/"
          
          # Create archives
          cd release
          tar -czvf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"
          
          # Also create zip for convenience
          zip -r "${ARCHIVE_NAME}.zip" "${ARCHIVE_NAME}"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: masmide-linux-${{ matrix.arch }}
          path: |
            release/*.tar.gz
            release/*.zip

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Collect release files
        run: |
          mkdir -p release-files
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-files/ \;
          ls -la release-files/
      
      - name: Generate checksums
        run: |
          cd release-files
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: masmide ${{ steps.version.outputs.version }}
          files: |
            release-files/*.tar.gz
            release-files/*.zip
            release-files/SHA256SUMS.txt
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          body: |
            ## Installation

            ### Quick Install (recommended)
            ```bash
            curl -sSL https://raw.githubusercontent.com/KM-Alee/masmide/main/scripts/install-remote.sh | bash
            ```

            ### Manual Install
            1. Download the appropriate archive for your system
            2. Extract: `tar -xzf masmide-*.tar.gz`
            3. Run: `cd masmide-* && sudo ./install.sh`

            ### Architectures
            - `x86_64` - Standard Linux (glibc) for Intel/AMD 64-bit
            - `aarch64` - ARM 64-bit (Raspberry Pi 4, Apple Silicon VMs, etc.)
            - `x86_64-musl` - Static binary, works on Alpine Linux and other musl-based distros

            ### Verify Download
            ```bash
            sha256sum -c SHA256SUMS.txt
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-crate:
    name: Publish to crates.io
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: dtolnay/rust-toolchain@stable
      
      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: true
